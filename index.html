<!DOCTYPE html>
<head>
  <meta charset="UTF-8">
  <title>HTML5 audio benchmarks</title>
  <style type="text/css">
    p{
      line-height:1.3em;
      margin:0;
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"   integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="   crossorigin="anonymous"></script>
  <script src="scripts/soundmanager2-2.97a.20170601.min.js"></script>
  <script src="scripts/howler-2.0.5.min.js"></script>

</head>
<body>

<h1>HTML5 Audio Benchmarks</h1>
<h2><a id="button" href="#">Click Me</a></h2>
<div id="output">
<p>Loading...<p>
</div>

<!-- <audio controls>
  <source src="https://alonetone.com/html5-audio-benchmarks/mp3/1min128kbps.mp3?123413" preload="none" >
</audio> -->


<script type="text/javascript">

  $('audio').on('canplay',function(){
    alert()
  })

  Tracks = {
    base: ['1min128kbps','1min256kbps','3min128kbps','3min256kbps','10min128kbps','10min256kbps'],
    linode:function(){
      return this.base.map(track => 'mp3/' + track + '.mp3?' + this.cacheBuster())
    },
    cacheBuster:function(){
      return Math.random().toString(36).substring(7)
    }

  }

  Test = {
    output: $('#output'),
    started: performance.now(),
    startedPlay: 0,
    numberOfIterations: 5,
    howls: [],
    currentlyPlaying: 0,
    currentTracks: [],
    results: [],
    log: function(msg){
      this.output.append("<p>" + this.relativeTime() + "ms: " + msg + "</p>")
    },
    logHeader:function(header){
      this.output.append("<h3>" + header + "</h3>")
    },
    relativeTime: function(){
      return Math.round(performance.now() - this.started)
    },
    logPlayTime: function(type, name){
      log("<b>" + name + "</b> " + type + " took " + Math.round(performance.now() - this.startedPlay) + 'ms')
    }
  }

  // convenience helper
  function log(msg){
    Test.log(msg)
  }

  $(function() {
    log("dom ready")
    $(document).on('canplay'), function(){
      alert()
    }
    $('#button').on('click',function(){
      play(0)
    })
    doTest()
  });

  function doTest(){
    //setupHowls()
    //window.playing = 0 // reset index
    Test.currentTracks = Tracks.linode()
    console.log(Test.currentTracks)
    setupSoundManager(false)
  }

  function play(track){
    log("start play")
    Test.startedPlay = performance.now()
    //Test.howls[Test.currentlyPlaying].play()
    soundManager.play("sound" + Test.currentTracks[track])
  }

  function playNext(soundID){
    var current = Test.currentTracks.indexOf(soundID.replace('sound',''))
    var next = Test.currentTracks[current + 1]
    if(next != undefined)
      play(current + 1)
  }

  function setupHowls(){
    for (i = 0; i < window.tracks.length; i++) {
      window.howls.push(new Howl({
        src: ['mp3/' + window.tracks[i] + '.mp3?' + Math.random().toString(36).substring(7)],
        html5: true,
        preload: false,
        onplay:function(){
          logPlayTime(window.tracks[window.playing])
          window.howls[window.playing].stop()
          window.playing += 1
          play()
        }
      }))
      log(window.tracks[i] + ' created')
    }
  }

  function setupSoundManager(preferFlash){
    soundManager.setup({
      url: '/scripts/',
      flashVersion: 9, // optional: shiny features (default = 8)
      // optional: ignore Flash where possible, use 100% HTML5 mode
      useHTML5Audio: true,
      onready: function() {
        log("soundmanager ready")
        for (i = 0; i < Test.currentTracks.length; i++) {
          soundManager.createSound({
            id: 'sound' + Test.currentTracks[i],
            url: Test.currentTracks[i],
            onload: function(){
              Test.logPlayTime('onload', this.id.replace('sound',''))
            },
            whileplaying: function(){
              amountBuffered = Math.round((this.buffered[0]["end"] - this.buffered[0]["start"]) / 1000)
              if(this.isHTML5)
                log("HTML5 audio buffered seconds: " + amountBuffered)
              else
                log("FLASH buffered seconds: " + amountBuffered)
              Test.logPlayTime('whileplaying', this.id.replace('sound',''))
              this.stop()
              this.unload()
              playNext(this.id)
            }
          })
          log(Test.currentTracks[i] + ' created')
        }
      }
    })
  }


</script>

</body>
</html>